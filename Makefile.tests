# VisualGasic bytecode regression harness

GODOT_BIN           ?= ./Godot_v4.5.1-stable_linux.x86_64
GODOT_PROJECT_DIR   ?= demo
GODOT_TEST_SCRIPT   ?= run_bytecode_tests.gd
GODOT_BENCH_SCRIPT  ?= run_benchmarks.gd
GODOT_DUMP_SCRIPT   ?= dump_bytecode.gd
SCONS_ARGS          ?= platform=linux target=template_release
BYTECODE_DUMP_ENTRIES ?= BenchArithmetic,BenchArraySum,BenchStringConcat,BenchBranch
BYTECODE_DUMP_OUTPUT ?= $(CURDIR)/bytecode_dump.json

.PHONY: all build test clean help \
	test-types test-async test-patterns test-repl test-gpu test-lsp \
	test-packages test-ecs test-debugging performance stress ci-test \
	reports godot-test memory-test coverage parallel-test docker-test \
	regression-test interactive smoke-test bench bytecode-dump \
	update-bytecode-baseline

define BYTECODE_DUMP_CAPTURE
	@echo "=== Capturing VisualGasic bytecode dump (JSON) ==="
	@$(GODOT_BIN) --headless --path $(GODOT_PROJECT_DIR) --script $(GODOT_DUMP_SCRIPT) --entries=$(BYTECODE_DUMP_ENTRIES) --json --out=$(BYTECODE_DUMP_OUTPUT)
	@echo "ðŸ“„ Bytecode dump saved to $(BYTECODE_DUMP_OUTPUT)"
endef

all: test

build:
	@echo "=== Building VisualGasic GDExtension ($(SCONS_ARGS)) ==="
	@scons $(SCONS_ARGS)
	@echo "âœ… GDExtension build complete"

test: build
	@echo "=== Running VisualGasic Bytecode VM tests via Godot ==="
	@$(GODOT_BIN) --headless --quiet --path $(GODOT_PROJECT_DIR) --script $(GODOT_TEST_SCRIPT)

bench: build
	@echo "=== Running VisualGasic benchmark suite ==="
	@$(GODOT_BIN) --headless --path $(GODOT_PROJECT_DIR) --script $(GODOT_BENCH_SCRIPT)
	$(BYTECODE_DUMP_CAPTURE)

bytecode-dump: build
	$(BYTECODE_DUMP_CAPTURE)

update-bytecode-baseline: bytecode-dump
	@cp "$(BYTECODE_DUMP_OUTPUT)" tests/bytecode_baseline.json
	@python3 scripts/update_bytecode_changelog.py --dump "$(BYTECODE_DUMP_OUTPUT)" --changelog README_UPDATES.md
	@echo "ðŸ“š Bytecode baseline and changelog updated"

# Historical aliases that now point to the unified bytecode suite.
test-types test-async test-patterns test-repl test-gpu test-lsp \
	 test-packages test-ecs test-debugging performance stress ci-test \
	 reports godot-test memory-test coverage parallel-test docker-test \
	 regression-test interactive smoke-test: test
	@echo "Alias target '$@' currently maps to the default bytecode regression run."

clean:
	@echo "=== Cleaning VisualGasic build artifacts ==="
	@scons -c $(SCONS_ARGS) >/dev/null || true
	@rm -f demo/bin/*.so
	@echo "ðŸ§¹ Clean complete"

help:
	@echo "VisualGasic Bytecode Regression Makefile"
	@echo "========================================"
	@echo "Targets:"
	@echo "  build  - Compile the GDExtension via SCons ($(SCONS_ARGS))"
	@echo "  test   - Run the bytecode regression suite inside headless Godot"
	@echo "  bench  - Execute the cross-language benchmark harness"
	@echo "  clean  - Remove compiled artifacts"
	@echo "  help   - Show this message"
	@echo ""
	@echo "Environment overrides:"
	@echo "  GODOT_BIN         Path to the Godot executable"
	@echo "  GODOT_PROJECT_DIR Project folder to run (default: demo)"
	@echo "  GODOT_TEST_SCRIPT Script launched with --script (default: run_bytecode_tests.gd)"
	@echo "  GODOT_BENCH_SCRIPT Benchmark script used by 'make bench' (default: run_benchmarks.gd)"
	@echo "  SCONS_ARGS        Arguments forwarded to SCons when building"